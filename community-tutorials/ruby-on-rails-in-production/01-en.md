---
title: Ruby On Rails in Production
description: How to install a Ruby On Rails production environment on Ubuntu 20.04
updated_at: 2021-11-05
slug: ruby-on-rails-in-production
author_name: Vincent Thelang
author_url: https://www.vincent-thelang.de/
author_image: https://secure.gravatar.com/avatar/46008cf5222702b38c774233aef9407a.png?r=PG&s=512
author_bio: -
tags: [shell,ruby,rails,ubuntu,nginx,passenger] 
netcup_product_url: https://www.netcup.de/bestellen/produkt.php?produkt=2554
language: en
available_languages: en
---

# Introduction

In this tutorial we will install Ruby on Rails from scratch to production. We used Ruby Version 3, Rails 7 and an Ubuntu 20.04 base image. I used this environment by myself on a VPS 1000 G9 and can recommend it for its performance. After the server has been ordered and the Ubuntu 20.04 image has been installed on it, we can connect to it via SSH.

# Requirements

* vServer or Root Server with Ubuntu 20.04
* Domain


# Installing Ruby

## Creating a user

First we create a separate User on our System:

```sh
adduser rails_user
adduser rails_user sudo
su rails_user
```


## Installing necessary Packages

Once we have connected to the server we can start to install some necessary packages. To guarantee the operation of Webpacker in Ruby on Rails we need to install node js and Yarn. Webpacker makes it easy to use the JavaScript pre-processor to manage application-like JavaScript in Rails.

To do this, we first need to add some repositories to our system:

```sh
curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash -
curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | sudo apt-key add -
echo "deb https://dl.yarnpkg.com/debian/ stable main" | sudo tee /etc/apt/sources.list.d/yarn.list
sudo add-apt-repository ppa:chris-lea/redis-server
```

Then we refresh our package list with the new repositories:

```sh
sudo apt-get update
```

Now we can install the necessary packages:

```sh
sudo apt-get install git-core curl zlib1g-dev build-essential libsqlite3-dev sqlite3 libssl-dev libreadline-dev libyaml-dev libsqlite3-dev sqlite3 libxml2-dev libxslt1-dev libcurl4-openssl-dev software-properties-common libffi-dev dirmngr gnupg apt-transport-https ca-certificates nodejs yarn
```


## Installing Rbenv and Ruby 


Once all the packages are installed, we can proceed with the actual installation of Ruby. Here we use "rbenv". Rbenv is a Ruby versions manger that makes it easier to deal with different Ruby versions and makes it easy to deal with gems and environment variables. 


The easiest way is to clone rbenv from Github, so we have the latest version. To do this, we proceed as follows:

```sh
git clone https://github.com/rbenv/rbenv.git ~/.rbenv
echo 'export PATH="$HOME/.rbenv/bin:$PATH"' >> ~/.bashrc
echo 'eval "$(rbenv init -)"' >> ~/.bashrc
git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
echo 'export PATH="$HOME/.rbenv/plugins/ruby-build/bin:$PATH"' >> ~/.bashrc
git clone https://github.com/rbenv/rbenv-vars.git ~/.rbenv/plugins/rbenv-vars
exec $SHELL
```

Once rbenv is installed we can continue with the installation of the Ruby version, in our example we install the current version 3.0.2, but this can also be changed to any version. 

```sh
rbenv install 3.0.2
rbenv global 3.0.2
ruby -v
```

If the version 3.0.2 appears after executing `ruby -v`, this has worked.

## Installing Bundler

In order to be able to install gems from the project in the future, we also need to install the bundler.

```sh
gem install bundler
bundle -v
```

If the Bundler version 2 is now displayed again, this has worked and we have completed the installation of ruby.


# Configuring Web Server


For our production environment we use the NGINX to receive http requests. The http requests are then passed on to Passenger, which ensures that this is executed in our Rails application.

## Installing NGINX & Passenger

To do this, we first have to add repositories to the system again:

```sh
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 561F9B9CAC40B2F7
sudo sh -c 'echo deb https://oss-binaries.phusionpassenger.com/apt/passenger focal main > /etc/apt/sources.list.d/passenger.list'
```

Then we update the list again:

```sh
sudo apt-get update
```

Now we can install NGINX and Passenger:

```sh
sudo apt-get install -y nginx-extras libnginx-mod-http-passenger
```

To activate Passenger in NGINX we have to execute the following 2 commands:

```sh
if [ ! -f /etc/nginx/modules-enabled/50-mod-http-passenger.conf ]; then sudo ln -s /usr/share/nginx/modules-available/mod-http-passenger.load /etc/nginx/modules-enabled/50-mod-http-passenger.conf ; fi
```

```sh
sudo ls /etc/nginx/conf.d/mod-http-passenger.conf
```

## Configuring NGINX & Passenger


Passenger comes with its own compiled Ruby version by default, I don't recommend using this as it can be outdated and we installed rbenv in advance which solves a lot of problems for us.

To adjust this we need to edit the following file:

```sh
sudo nano /etc/nginx/conf.d/mod-http-passenger.conf
```

There we change the line to the following:

```diff
- passenger_ruby /usr/bin/passenger_free_ruby;
+ passenger_ruby /home/rails_user/.rbenv/shims/ruby;
```

Once we have saved the file, we execute the following command to start NGINX:

```sh
sudo service nginx start
```

If we now access the IP or address of the server via Webbrowser and receive the message "Welcome to NGINX", we have configured NGINX correctly.


Now we can create a new configuration file by creating the following file with the editor nano:

```sh
sudo nano /etc/nginx/sites-enabled/rails_app
```

We copy the following content into it:

```
server {
  listen 80;
  listen [::]:80;

  server_name YOUR_DOMAIN;
  root /var/www/rails_app/public;

  passenger_enabled on;
  passenger_app_env production;

  location /cable {
    passenger_app_group_name myapp_websocket;
    passenger_force_max_concurrent_requests_per_process 0;
  }

  client_max_body_size 10m;

  location ~ ^/(assets|packs) {
    expires max;
    gzip_static on;
  }
}
```

You can modify the following details according to your needs:

* server_name
  * Instead of the `YOUR_DOMAIN`, you can enter your domain here on which your Rails app should run.
* root
  * `/var/www/rails_app` is the location of our Rails app. You can customise this, the important thing is that the path always ends with `/public`.
* passenger_app_env
  * If you prefer to run your Rails app for development in the development environment, you can specify `development` here instead of `production`.
* location /cable
  * If you are sure that your app will not use an action cable for websockets, you can remove this block from the file.
* client_max_body_size
  * If you want to allow your users to upload files to your Rails app, you can set a maximum upload file size here. In the default setting, this is 10 MB.
* location ~ ^/(assets|packs)
  * The assets and packs directories contain javascript and css files from your Rails app. To make these files more performant, they are cached and zipped with the block. You can extend this with more directories.


Once you have saved the file, we change to the directory `/var/www/`. Now you can copy your existing Rails app into the folder `rails_app`. Alternatively, you can use tools like Capistrano for deployment.

To install Rails, use the gem install command provided by RubyGems:

```sh
gem install rails
```

If you want to start from scratch, you can create a new rails app here with the name `rails_app` and execute the following command:

```sh
rails new rails_app
```

After creating the project folder, rails new runs bundle install to install the necessary gems and then yarn to install the necessary JS dependencies. We can then switch to the project folder using `cd rails_app` and start development. Happy Coding ;) 

Sqlite3 was selected by default as the database, which is sufficient for small applications in most cases. If you want to do more, install PostgreSQL or another database on the server and configure it in your Rails app.


To finally compile the javascript files execute the following command:

```sh
RAILS_ENV=production rails assets:precompile
```

Now we are almost done, we just need to reload NGINX and we can view our Rails app in the web browser.

For this purpose we execute the comando:

```sh
sudo service nginx reload
```

# Conclusion
If we now access our Ip or server address or routed domain and get our Rails app displayed, we have done it.
But beware, this is an unencrypted HTTP connection, if you want to make your application available to other users, please install at least Lets Encrypt and install it in your NGINX. 

# License
MIT

# Contributor's Certificate of Origin
Contributor's Certificate of Origin By making a contribution to this project, I certify that:

 1) The contribution was created in whole or in part by me and I have the right to submit it under the license indicated in the file; or

 2) The contribution is based upon previous work that, to the best of my knowledge, is covered under an appropriate license and I have the right under that license to submit that work with modifications, whether created in whole or in part by me, under the same license (unless I am permitted to submit under a different license), as indicated in the file; or

 3) The contribution was provided directly to me by some other person who certified (a), (b) or (c) and I have not modified it.

 4) I understand and agree that this project and the contribution are public and that a record of the contribution (including all personal information I submit with it, including my sign-off) is maintained indefinitely and may be redistributed consistent with this project or the license(s) involved.

Signed-off-by: Vincent Thelang | [info@vincent-thelang.de](mailto:info@vincent-thelang.de)

