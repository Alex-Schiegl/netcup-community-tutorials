---
title: Edit and Shrink a QCOW2 Snapshot (with Qemu on Windows or other OSs)
description: Learn how to work on the contents of a qcow2 virtual server snapshot and shrink the snapshot file to just the size of the used space afterwards.
level: [intermediate]
updated_at: 2023-04-03
slug: edit-and-shrink-a-qcow2-snapshot
author_name: NaN
author_url:
author_image:
author_bio:
tags: [qemu,qcow2,server,snapshot,edit,shrink]
netcup_product_url:
language: en
available_languages: [en, de]
---

# Introduction
This tutorial describes how to work on the contents of a qcow2 virtual server snapshot and shrink the snapshot file to just the size of the used space.

This is useful, for example, when storing a snapshot that includes large amounts of data backed up somewhere else. Shrinking the size of the snapshot file reduces the time it takes to reupload it to a virtual server.

The aim of this tutorial is to show a method which is feasible on a Windows host. It can be useful on other operating systems as well.

# Requirements
This method requires enough hard disk space to store the unedited disk image file in addition to a copy with the unnecessary data removed.

It is assumed that the snapshot image has already been downloaded and is in qcow2 format. The user should be sufficiently familiar with the Linux CLI to navigate a file system and selectively delete unwanted files.

# Step 1 - Download and install Qemu
Download the binaries for [QEMU](https://www.qemu.org/download/#windows) and install them.

# Step 2 - Download a Live-ISO of Alpine Linux
[Alpine Linux](https://alpinelinux.org/downloads/) is a lightweight Linux distribution. For the purpose of this tutorial, download the "Virtual" x86_64 ISO file.

# Step 3 - Start a virtual machine
Use QEMU to start a virtual machine with Alpine Linux as the OS and the qcow2 snapshot file as the virtual hard disk:

`qemu-system-x86_64.exe -m 2048 -smp 4 -boot d -cdrom alpine-virt-3.17.3-x86_64.iso -drive if=virtio,driver=qcow2,discard=on,file=diskimage.qcow2`

You may need to prepend the paths of the qemu binary, the alpine ISO and the disk image. Also adjust the name of the ISO file to the one you downloaded.

The `-m 2048` option specifies 2GB of RAM for the virtual machine. With `-smp 4`, four virtual CPU cores are assigned to the VM. The `-boot d` parameter sets the boot device to the cdrom ISO, which is given with the `-cdrom` parameter.

The `-drive` parameter instructs QEMU to attach the virtual hard disk as a virtio device, backed by the qcow2 driver, and to pass discard instructions through to the driver.

For compatibility, the given command does not enable hardware acclerated virtualization, so the execution may be slower than expected. You can try `-accel whpx` or `-accel haxm` on Windows and `-accel kvm` on Linux, but if that doesn't work, just use the slower software emulation.

# Step 4 - Edit the hard disk from inside Alpine Linux
1. Log in as root with no password

2. Change the keymap if you're not using a US keyboard layout:

   `setup-keymap`

   Type setup, press the tab key to get the hyphen, type keymap.

   For a German keyboard layout, enter 'de' twice.

3. You can list the partitions with

   `fdisk -l`

4. Mount the partition you want to work on, for example /dev/vda1:

   `mount /dev/vda1 /mnt`

5. Delete the files that you want to purge from the snapshot

   `cd /mnt`

   ...use cd, find, rm, etc. to look around and delete unnecessary files...

   `cd /`

6. Mark the empty space in the filesystem as unused

   `fstrim -v /mnt`

7. Unmount the partition

   `umount /mnt`

8. Turn off the virtual machine

   `poweroff`

# Step 5 - Expunge the unused space from the snapshot image
Now that the empty space in the disk image file has been marked as unallocated, "converting" the disk image with qemu-img will not copy the freed space.

`qemu-img.exe convert -f qcow2 -O qcow2 diskimage.qcow2 diskimage-trimmed.qcow2`

Again, you may need to prepend paths.

The qcow2 file format supports compression, which can further reduce the size of the snapshot file. This can optionally be enabled with `-c`, but increases conversion time significantly:

`qemu-img.exe convert -f qcow2 -O qcow2 -c diskimage.qcow2 diskimage-trimmed.qcow2`

# Conclusion
After this tutorial, you have two copies of the snapshot disk image: the original one with the changes you made in the VM and the copy which is shrunk to the size without the deleted files. You can delete the larger image file. The smaller image file does not depend on it.

# Licence

[MIT](https://github.com/netcup-community/community-tutorials/blob/main/LICENSE)

Copyright (c) 2021 netcup

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicence, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

# Contributor's Certificate of Origin
By making a contribution to this project, I certify that:

 1) The contribution was created in whole or in part by me and I have the right to submit it under the licence indicated in the file; or

 2) The contribution is based upon previous work that, to the best of my knowledge, is covered under an appropriate licence and I have the right under that licence to submit that work with modifications, whether created in whole or in part by me, under the same licence (unless I am permitted to submit under a different licence), as indicated in the file; or

 3) The contribution was provided directly to me by some other person who certified (a), (b) or (c) and I have not modified it.

 4) I understand and agree that this project and the contribution are public and that a record of the contribution (including all personal information I submit with it, including my sign-off) is maintained indefinitely and may be redistributed consistent with this project or the licence(s) involved.
